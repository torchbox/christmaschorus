<!DOCTYPE HTML>
<html>
	<head>
		<title>Trolololthesizer</title>
		<script src="{{ STATIC_URL }}js/jquery-1.6.2.min.js"></script>
		<script src="{{ STATIC_URL }}lib/colorbox/jquery.colorbox.min.js"></script>
		<link rel="stylesheet" href="{{ STATIC_URL }}lib/colorbox/colorbox.css" />
		<script src="{{ STATIC_URL }}js/json2.js"></script>
		<script>
			NOTES_BY_KEYCODE = {
				90: 'c2', 83: 'cs2', 88: 'd2', 68: 'ds2', 67: 'e2',
				86: 'f2', 71: 'fs2', 66: 'g2', 72: 'gs2', 78: 'a2', 74: 'as2', 77: 'b2', 188: 'c3'
			}
			
			var keysPressed = {};
			
			var keyboardActive = true;
			
			$(function() {
				$(document).keydown(function(e) {
					if (!keyboardActive) return;
					if (e.shiftKey || e.metaKey || e.ctrlKey || e.altKey) return;
					var note = NOTES_BY_KEYCODE[e.which];
					if (note && !keysPressed[e.which]) {
						keysPressed[e.which] = true;
						playNote(note);
					}
				}).keyup(function(e) {
					var note = NOTES_BY_KEYCODE[e.which];
					if (note) keysPressed[e.which] = false;
				})
				$('video').mousedown(function() {
					playNote(this.id);
				})
				
				var isRecording = false;
				var recordingStartTime = null;
				var recordedNotes = {{ song.notes_json|safe }};
				
				$('#record').click(function() {
					if (!isRecording) {
						$('#record').val('Stop recording');
						isRecording = true;
						recordedNotes = [];
						recordingStartTime = null; /* start counting time on next note */
					} else {
						$('#record').val('Record');
						isRecording = false;
						$('#id_notes_json').val(JSON.stringify(recordedNotes));
					}
				})
				
				$('#play').click(function() {
					function getPlayCallbackForNote(note) {
						return function() {playNote(note)}
					}
					for (var i = 0; i < recordedNotes.length; i++) {
						setTimeout(getPlayCallbackForNote(recordedNotes[i].note), recordedNotes[i].time);
					}
				})
				
				function playNote(note) {
					var video = document.getElementById(note);
					video.currentTime = 0;
					video.play();
					if (isRecording) {
						var currentTime = (new Date).getTime();
						if (!recordingStartTime) {
							recordingStartTime = currentTime;
						}
						recordedNotes.push({
							time: currentTime - recordingStartTime,
							note: note
						});
					}
				}
				
				/* Disable playing by keyboard while lightbox is open */
				$(document).bind('cbox_open', function() { keyboardActive = false; })
				$(document).bind('cbox_closed', function() { keyboardActive = true; })
				
				$('#share').colorbox({'inline': true, 'href': '#save_popup'});
			})
		</script>
		<style>
			.popups {
				display: none;
			}
		</style>
	</head>
	<body>
		<div id="notes">
			<video id="c2" width="166" height="100"><source src="http://localhost/~matthew/tbx/card/c2.m4v" type="video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;" /></video>
			<video id="cs2" width="166" height="100"><source src="http://localhost/~matthew/tbx/card/cs2.m4v" type="video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;" /></video>
			<video id="d2" width="166" height="100"><source src="http://localhost/~matthew/tbx/card/d2.m4v" type="video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;" /></video>
			<video id="ds2" width="166" height="100"><source src="http://localhost/~matthew/tbx/card/ds2.m4v" type="video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;" /></video>
			<video id="e2" width="166" height="100"><source src="http://localhost/~matthew/tbx/card/e2.m4v" type="video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;" /></video>
			<video id="f2" width="166" height="100"><source src="http://localhost/~matthew/tbx/card/f2.m4v" type="video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;" /></video>
			<video id="fs2" width="166" height="100"><source src="http://localhost/~matthew/tbx/card/fs2.m4v" type="video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;" /></video>
			<video id="g2" width="166" height="100"><source src="http://localhost/~matthew/tbx/card/g2.m4v" type="video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;" /></video>
			<video id="gs2" width="166" height="100"><source src="http://localhost/~matthew/tbx/card/gs2.m4v" type="video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;" /></video>
			<video id="a2" width="166" height="100"><source src="http://localhost/~matthew/tbx/card/a2.m4v" type="video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;" /></video>
			<video id="as2" width="166" height="100"><source src="http://localhost/~matthew/tbx/card/as2.m4v" type="video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;" /></video>
			<video id="b2" width="166" height="100"><source src="http://localhost/~matthew/tbx/card/b2.m4v" type="video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;" /></video>
			<video id="c3" width="166" height="100"><source src="http://localhost/~matthew/tbx/card/c3.m4v" type="video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;" /></video>
		</div>
		
		{% if song.id %}
			<h1>{{ song.title }}</h1>
			
			{% with song.score as score %}
				<p>{{ score }} vote{{ score|pluralize }}</p>
				<form action="{% url vote song.code %}" method="POST">
					{% csrf_token %}
					<input type="hidden" name="score" value="1" />
					<input type="submit" value="+" />
				</form>
				<form action="{% url vote song.code %}" method="POST">
					{% csrf_token %}
					<input type="hidden" name="score" value="-1" />
					<input type="submit" value="-" />
				</form>
			{% endwith %}
			
			<a href="https://twitter.com/share" class="twitter-share-button" data-text="The Torchbox trololol chorus presents: {{ song.title }}" data-count="vertical" data-via="torchbox">Tweet</a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
			<!-- TODO: insert domain in facebook share link -->
			<iframe src="https://www.facebook.com/plugins/like.php?href=http://torchbox.com{{ song.get_absolute_url }}"
				scrolling="no" frameborder="0"
				style="border:none; width:450px; height:80px"></iframe>
		{% else %}
			<a href="https://twitter.com/share" class="twitter-share-button" data-text="Torchbox wishes you a musical trololol Christmas!" data-count="vertical" data-via="torchbox">Tweet</a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
			<!-- TODO: insert domain in facebook share link -->
			<iframe src="https://www.facebook.com/plugins/like.php?href=http://torchbox.com/"
				scrolling="no" frameborder="0"
				style="border:none; width:450px; height:80px"></iframe>
		{% endif %}
		
		<div id="controls">
			<input type="button" id="record" value="Record" />
			<input type="button" id="play" value="Play" />
		</div>
		
		<input type="button" id="share" value="Share" />
		
		<h2>Latest songs</h2>
		<ul>
			{% for song in latest_songs %}
				<li><a href="{{ song.get_absolute_url }}">{{ song.title }}</a></li>
			{% endfor %}
		</ul>
		
		<div class="popups">
			<div id="save_popup">
				<form action="{% url create_song %}" method="post">
					{% csrf_token %}
					<p>Enter a title for your song:</p>
					
					<table>
						{{ form }}
					</table>
					<input type="submit" value="Share it!" />
			</div>
		</div>
	</body>
</html>
